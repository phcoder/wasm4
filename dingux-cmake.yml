.libretro-dingux-cmake:
  image: $CI_SERVER_HOST:5050/libretro-infrastructure/libretro-build-dingux:latest
  stage: build-shared
  variables:
    LIBNAME:               ${CORENAME}_libretro.so
    BUILD_DIR:             build/dingux-$ARCH
    DINGUX_TOOLCHAIN_FILE: /opt/gcw0-toolchain/usr/share/buildroot/toolchainfile.cmake
    STRIP:                 /opt/gcw0-toolchain/usr/bin/mipsel-gcw0-linux-uclibc-strip
    STRIP_CORE_LIB:        1
    CMAKE_SOURCE_ROOT:     .
  before_script:
    - export NUMPROC=$(($(nproc)/5))
  script:
    - cmake $CORE_ARGS "$CMAKE_SOURCE_ROOT" -B$BUILD_DIR -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=$DINGUX_TOOLCHAIN_FILE -DCMAKE_C_FLAGS="$DINGUX_CFLAGS" -DCMAKE_CXX_FLAGS="$DINGUX_CXXFLAGS"
    - cmake --build $BUILD_DIR --target ${CORENAME}_libretro --config Release -- -j $NUMPROC
    - mv $BUILD_DIR/$EXTRA_PATH/$LIBNAME $LIBNAME
    - if [ $STRIP_CORE_LIB -eq 1 ]; then $STRIP --strip-unneeded $LIBNAME; fi
  artifacts:
    paths:
      - $LIBNAME
    expire_in: 10 min
  dependencies: []

.libretro-dingux-cmake-mips32:
  extends: .libretro-dingux-cmake
  variables:
    ARCH:            mips32
    DINGUX_CFLAGS:   -fomit-frame-pointer -march=mips32 -mtune=mips32r2 -mhard-float -ffast-math
    DINGUX_CXXFLAGS: -fomit-frame-pointer -march=mips32 -mtune=mips32r2 -mhard-float -ffast-math

.libretro-dingux-odbeta-cmake-mips32:
  image: $CI_SERVER_HOST:5050/libretro-infrastructure/libretro-build-dingux:odbeta
  extends: .libretro-dingux-cmake-mips32
  variables:
    DINGUX_TOOLCHAIN_FILE: /opt/cmake_toolchain_files/odbeta.cmake

.libretro-rs90-odbeta-cmake-mips32:
  image: $CI_SERVER_HOST:5050/libretro-infrastructure/libretro-build-dingux:odbeta
  extends: .libretro-dingux-cmake-mips32
  variables:
    DINGUX_TOOLCHAIN_FILE: /opt/rs90-toolchain/usr/share/buildroot/toolchainfile.cmake
    STRIP:                 /opt/rs90-toolchain/usr/bin/mipsel-rs90-linux-uclibc-strip

.libretro-retrofw-odbeta-cmake-mips32:
  image: $CI_SERVER_HOST:5050/libretro-infrastructure/libretro-build-dingux:odbeta
  extends: .libretro-dingux-cmake-mips32
  variables:
    DINGUX_TOOLCHAIN_FILE: /opt/retrofw-toolchain/usr/share/buildroot/toolchainfile.cmake
    STRIP:                 /opt/retrofw-toolchain/usr/bin/mipsel-retrofw-linux-uclibc-strip
